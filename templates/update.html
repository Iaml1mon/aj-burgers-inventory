{% extends 'base.html' %}

{% block title %}Inventory - AJ Burgers{% endblock %}

{% block content %}
  <h1 class="page-title">Update Inventory</h1>
  <div class="search-filter">
    <input type="text" id="search" class="search-input" placeholder="Search items or categories…" oninput="updateFilters()" />
    <div class="filter-buttons">
      <button type="button" class="filter-btn active" data-filter="all" onclick="setFilter('all')">All</button>
      <button type="button" class="filter-btn" data-filter="needs" onclick="setFilter('needs')">Out of Stock</button>
      <button type="button" class="filter-btn" data-filter="low" onclick="setFilter('low')">Low Stock</button>
      <button type="button" class="filter-btn" data-filter="good" onclick="setFilter('good')">Good</button>
    </div>
  </div>
  <form method="post" id="inventory-form">
    <div class="inventory-list">
      {% for item in items %}
      <div class="inventory-item-card {{ 'needs' if item.quantity == 0 else 'low' if item.quantity < item.threshold else 'good' }}" data-name="{{ item.item_name | lower }}" data-category="{{ item.category | lower }}" data-status="{{ 'needs' if item.quantity == 0 else 'low' if item.quantity < item.threshold else 'good' }}">
        <div class="item-header">
          <span class="item-name">{{ item.item_name }}</span>
          <span class="item-category">{{ item.category }}</span>
        </div>
        <div class="item-quantity">
          <label>Quantity</label>
          <div class="qty-control">
            <button type="button" class="qty-btn" data-step="-10" data-target="quantity_{{ item.id }}">−10</button>
            <button type="button" class="qty-btn" data-step="-5" data-target="quantity_{{ item.id }}">−5</button>
            <button type="button" class="qty-btn" data-step="-1" data-target="quantity_{{ item.id }}">−1</button>
            <input type="number" id="quantity_{{ item.id }}" name="quantity_{{ item.id }}" value="{{ item.quantity }}" min="0" />
            <button type="button" class="qty-btn" data-step="1" data-target="quantity_{{ item.id }}">+1</button>
            <button type="button" class="qty-btn" data-step="5" data-target="quantity_{{ item.id }}">+5</button>
            <button type="button" class="qty-btn" data-step="10" data-target="quantity_{{ item.id }}">+10</button>
          </div>
        </div>
        <div class="item-threshold">
          <label>Threshold</label>
          <input type="number" name="threshold_{{ item.id }}" value="{{ item.threshold }}" min="0" />
        </div>
      </div>
      {% endfor %}
    </div>
    <div class="save-container">
      <button type="submit" class="btn-save btn-block">Save Changes</button>
    </div>
  </form>

  <script>
    // Filtering logic
    // Set initial filter from query parameter (default to 'all')
    let currentFilter = '{{ request.args.get("filter", "all") }}';
    function setFilter(filter) {
      currentFilter = filter;
      // Update active state on buttons
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
      });
      updateFilters();
    }
    function updateFilters() {
      const searchTerm = document.getElementById('search').value.toLowerCase();
      document.querySelectorAll('.inventory-item-card').forEach(card => {
        const name = card.dataset.name;
        const category = card.dataset.category;
        const status = card.dataset.status;
        const matchSearch = name.includes(searchTerm) || category.includes(searchTerm);
        const matchFilter = currentFilter === 'all' || status === currentFilter;
        card.style.display = (matchSearch && matchFilter) ? '' : 'none';
      });
    }
    // Quantity adjust
    document.addEventListener('DOMContentLoaded', () => {
      // Attach events to increment/decrement buttons
      document.querySelectorAll('.qty-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const targetId = btn.dataset.target;
          const step = parseInt(btn.dataset.step);
          const input = document.getElementById(targetId);
          if (input) {
            const current = parseInt(input.value) || 0;
            const newVal = Math.max(0, current + step);
            input.value = newVal;
          }
        });
      });
      // Apply initial filter when page loads
      setFilter(currentFilter);
    });
  </script>
{% endblock %}