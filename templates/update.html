{% extends 'base.html' %}

{% block title %}Inventory - AJ Burgers{% endblock %}

{% block content %}
  <h1 class="page-title">Update Inventory</h1>
  <!-- Search and filter row -->
  <div class="search-filter">
    <input type="text" id="search" class="search-input" placeholder="Search items or categories…" oninput="updateFilters()" />
    <div class="filter-buttons">
      <button type="button" class="filter-btn" data-filter="all" onclick="setFilter('all')">All</button>
      <button type="button" class="filter-btn" data-filter="needs" onclick="setFilter('needs')">Out of Stock</button>
      <button type="button" class="filter-btn" data-filter="low" onclick="setFilter('low')">Low Stock</button>
      <button type="button" class="filter-btn" data-filter="good" onclick="setFilter('good')">Good</button>
      <!-- Today’s Order shortcut links to order page -->
      <a href="{{ url_for('order') }}" class="filter-btn order-btn">Order Today</a>
    </div>
  </div>
  <form method="post" id="inventory-form">
    <div class="inventory-list">
      {% for category, items_list in categories.items() %}
        <div class="category-header">{{ category }}</div>
        {% for item in items_list %}
        <div class="inventory-item-card {{ item.status }}" data-name="{{ item.item_name | lower }}" data-category="{{ category | lower }}" data-status="{{ item.status }}">
          <div class="item-header">
            <div class="item-header-left">
              {% if item.status == 'needs' or item.status == 'low' %}<span class="pulse-icon {{ item.status }}"></span>{% endif %}
              <span class="item-name">{{ item.item_name }}</span>
            </div>
            <span class="status-badge {{ item.status }}">{{ 'Out' if item.status == 'needs' else 'Low' if item.status == 'low' else 'Good' }}</span>
          </div>
          <div class="item-quantity">
            <label>Quantity</label>
            <input type="number" class="qty-number" id="quantity_{{ item.id }}" name="quantity_{{ item.id }}" value="{{ item.quantity }}" min="0" max="{{ item.threshold * 3 if item.threshold > 0 else 100 }}" oninput="document.getElementById('slider_{{ item.id }}').value = this.value" />
            <input type="range" class="qty-slider" id="slider_{{ item.id }}" min="0" max="{{ item.threshold * 3 if item.threshold > 0 else 100 }}" value="{{ item.quantity }}" step="1" oninput="document.getElementById('quantity_{{ item.id }}').value = this.value" />
          </div>
          <div class="item-threshold">
            <label>Threshold</label>
            <input type="number" name="threshold_{{ item.id }}" value="{{ item.threshold }}" min="0" />
          </div>
        </div>
        {% endfor %}
      {% endfor %}
    </div>
    <div class="save-container">
      <button type="submit" class="btn-save btn-block">Save Changes</button>
    </div>
  </form>

  <script>
    // Filtering logic
    // Set initial filter from query parameter (default to 'all')
    let currentFilter = '{{ request.args.get("filter", "all") }}';
    function setFilter(filter) {
      currentFilter = filter;
      // Update active state on buttons
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
      });
      updateFilters();
    }
    function updateFilters() {
      const searchTerm = document.getElementById('search').value.toLowerCase();
      document.querySelectorAll('.inventory-item-card').forEach(card => {
        const name = card.dataset.name;
        const category = card.dataset.category;
        const status = card.dataset.status;
        const matchSearch = name.includes(searchTerm) || category.includes(searchTerm);
        const matchFilter = currentFilter === 'all' || status === currentFilter;
        card.style.display = (matchSearch && matchFilter) ? '' : 'none';
      });
    }
    document.addEventListener('DOMContentLoaded', () => {
      // Set initial active filter button
      setFilter(currentFilter);
    });
  </script>
{% endblock %}